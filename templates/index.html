<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat TITI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>
    <!-- Đăng ký -->
    <div id="registerPage" class="page">
        <div class="background-image"></div>
        <div class="register-container">
            <div class="info-left">
                <div class="logo">
                    <img src="{{ url_for('static', filename='image/Logo.png') }}" alt="Logo">
                    <span>CHAT TITI</span>
                </div>
                <h1>Already have an account?</h1>
                <p>Welcome back! Please sign in with your personal info.</p>
            </div>
            <div class="form-right">
                <h2>Create Account</h2>
                <form id="registerForm">
                    <div class="input-group">
                        <input type="email" id="reg_email" required>
                        <label for="reg_email">E-MAIL</label>
                    </div>
                    <div class="input-group">
                        <input type="text" id="reg_fullname" required>
                        <label for="reg_fullname">Họ tên</label>
                    </div>
                    <div class="input-group">
                        <input type="password" id="reg_password" required>
                        <label for="reg_password">PASSWORD</label>
                    </div>
                    <input type="checkbox" id="reg_terms" name="terms">
                    <label for="reg_terms">I agree to the <a href="#">Terms & Conditions</a></label>
                    <button type="submit" class="btn-signup">SIGN UP</button>
                    <p>Nếu bạn đã có tài khoản! <a href="#" onclick="showPage('loginPage')">Login</a></p>
                </form>
            </div>
        </div>
    </div>

    <!-- Đăng nhập -->
    <div id="loginPage" class="page">
        <div class="background-image"></div>
        <div class="login-container">
            <div class="login-left">
                <div class="logo">
                    <img src="{{ url_for('static', filename='image/Logo.png') }}" alt="Logo">
                    <span>CHAT TITI</span>
                </div>
                <h1>Don't have an account?</h1>
                <p>Please contact your Administrator to get an account.</p>
            </div>
            <div class="login-right">
                <h2>LOGIN</h2>
                <form id="loginForm">
                    <div class="input-group">
                        <input type="email" id="login_email" placeholder="E-MAIL" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="login_password" placeholder="PASSWORD" required>
                    </div>
                    <button type="submit" class="btn-signin">SIGN IN</button>
                    <p>Nếu bạn chưa có tài khoản! <a href="#" onclick="showPage('registerPage')">Register</a></p>
                </form>
            </div>
        </div>
    </div>

    <!-- Chat -->
    <div id="chatPage" class="page" style="width: 100%;">
        <main>
            <div class="menu">
                <div class="menu_container">
                    <div class="hamburger"><span></span><span></span><span></span></div>
                </div>
                <a href="#" class="menu_title">Cuộc trò chuyện mới</a>
                <div class="hospital"></div>
            </div>

            <div class="conversation_container" style="width: 1275px;">
                <div class="logo">
                    <h2>TITI BOT</h2>
                    <h1>CHAT TITI</h1>
                    <a href="#" id="userLink" onclick="showPage('loginPage')">Đăng Kí/Đăng Nhập</a>
                </div>
                <div id="chat-container" class="chat-messages"></div>
                <div class="chat-input-area">
                    <label for="audio-file" class="icon-button upload-button">
                        <i class="fas fa-upload"></i>
                    </label>
                    <input type="file" id="audio-file" accept="audio/*" style="display: none;">
                    <button id="mic-btn" class="icon-button mic-button">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <input type="text" id="message-input" placeholder="Nhập tin nhắn của bạn..." class="message-input">
                    <button id="send-btn" class="send-button">
                        <i class="fas fa-paper-plane"></i> Gửi
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        function showPage(pageId) {
            document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
            document.getElementById(pageId).classList.add("active");
        }
        showPage("loginPage");

        // ===== Đăng ký =====
        document.getElementById('registerForm').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('reg_email').value.trim();
            const fullname = document.getElementById('reg_fullname').value.trim();
            const password = document.getElementById('reg_password').value.trim();
            const terms = document.getElementById('reg_terms').checked;
            if (!terms) return alert('Bạn phải đồng ý điều khoản!');
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Email: email, HoTen: fullname, Password: password })
                });
                const data = await res.json();
                if (res.ok && data.status === 'success') {
                    alert('Đăng ký thành công!');
                    showPage('loginPage');
                } else alert(data.message || 'Đăng ký thất bại');
            } catch (err) { alert('Lỗi: ' + err); }
        });

        // ===== Đăng nhập =====
        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('login_email').value.trim();
            const password = document.getElementById('login_password').value.trim();
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Email: email, Password: password })
                });
                const data = await res.json();
                if (res.ok && data.user) {
                    sessionStorage.setItem('currentUser', JSON.stringify(data.user));
                    alert('Đăng nhập thành công!');
                    showPage('chatPage');
                    document.getElementById('userLink').textContent = data.user.name || data.user.Email;
                } else alert(data.message || 'Đăng nhập thất bại');
            } catch (err) { alert('Lỗi: ' + err); }
        });

        // ===== Chat =====
        const input = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-btn");
        const conversation = document.getElementById("chat-container");
        const micBtn = document.getElementById("mic-btn");
        const audioFileInput = document.getElementById("audio-file");

        let conversations = JSON.parse(localStorage.getItem("conversations")) || [];
        let currentConversation = { id: Date.now(), title: "Cuộc trò chuyện mới", messages: [] };

        function addMessage(sender, text) {
            const wrapper = document.createElement("div");
            wrapper.className = "message " + sender;
            const p = document.createElement("p");
            p.textContent = text;
            wrapper.appendChild(p);

            if (sender !== "user") {
                const loa = document.createElement("i");
                loa.className = "fas fa-volume-up icon_loa";
                loa.addEventListener("click", () => {
                    fetch('/tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text })
                    })
                    .then(res => res.ok ? res.blob() : Promise.reject('Lỗi TTS'))
                    .then(blob => new Audio(URL.createObjectURL(blob)).play())
                    .catch(err => console.error(err));
                });
                wrapper.appendChild(loa);
            }

            conversation.appendChild(wrapper);
            conversation.scrollTop = conversation.scrollHeight;
            const chatTitle = document.querySelector(".conversation_container .logo h1");
            if (chatTitle) chatTitle.style.display = "none";
            currentConversation.messages.push({ sender, text });
            saveConversations();
        }

        function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            addMessage("user", text);
            input.value = "";

            fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            })
            .then(res => res.json())
            .then(data => {
                if (data.response) {
                    addMessage("bot", data.response);
                    // Auto-play TTS
                    fetch('/tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: data.response })
                    })
                    .then(res => res.ok ? res.blob() : Promise.reject('Lỗi TTS'))
                    .then(blob => new Audio(URL.createObjectURL(blob)).play())
                    .catch(err => console.error(err));
                } else addMessage("bot", "Lỗi: Không nhận được phản hồi.");
            })
            .catch(err => {
                console.error(err);
                addMessage("bot", "Đã xảy ra lỗi khi kết nối với máy chủ.");
            });
        }

        input.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });
        sendBtn.addEventListener("click", sendMessage);

        // ===== Ghi âm micro =====
        let mediaRecorder, audioChunks = [];

        micBtn.addEventListener("click", () => {
            if (micBtn.classList.contains("recording")) {
                micBtn.classList.remove("recording");
                mediaRecorder.stop();
            } else {
                micBtn.classList.add("recording");
                audioChunks = [];
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const formData = new FormData();
                            formData.append('audio', audioBlob, 'recording.webm');
                            fetch('/stt', { method: 'POST', body: formData })
                                .then(res => res.json())
                                .then(data => {
                                    if (data.transcript) {
                                        document.getElementById("message-input").value = data.transcript;
                                    } else {
                                        alert("Lỗi STT: " + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(err => console.error("Lỗi STT:", err));
                        };
                        mediaRecorder.start();
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Không thể truy cập micro. Vui lòng cho phép quyền truy cập.");
                    });
            }
        });

        // ===== Upload file audio =====
        audioFileInput.addEventListener("change", event => {
            const file = event.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('audio', file);
            fetch('/stt', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.transcript) {
                        document.getElementById("message-input").value = data.transcript;
                    } else {
                        alert("Lỗi STT: " + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => console.error("Lỗi STT:", err));
        });

        // ===== Lưu và render lịch sử =====
        function saveConversations() {
            localStorage.setItem("conversations", JSON.stringify(conversations));
        }

        function renderHistory() {
            const history = document.querySelector(".hospital");
            history.innerHTML = "";
            conversations.forEach(conv => {
                const wrapper = document.createElement("div");
                wrapper.className = "history-item";

                const a = document.createElement("a");
                a.href = "#";
                a.textContent = conv.title;
                a.addEventListener("click", () => loadConversation(conv.id));

                const delBtn = document.createElement("span");
                delBtn.textContent = "❌";
                delBtn.className = "delete-btn";
                delBtn.addEventListener("click", e => {
                    e.stopPropagation();
                    deleteConversation(conv.id);
                });

                wrapper.appendChild(a);
                wrapper.appendChild(delBtn);
                history.appendChild(wrapper);
            });
        }

        function deleteConversation(id) {
            conversations = conversations.filter(c => c.id !== id);
            saveConversations();
            renderHistory();
            if (currentConversation.id === id) {
                conversation.innerHTML = "";
                currentConversation = { id: Date.now(), title: "Cuộc trò chuyện mới", messages: [] };
            }
        }

        function loadConversation(id) {
            const conv = conversations.find(c => c.id === id);
            if (!conv) return;
            currentConversation = conv;
            conversation.innerHTML = "";
            conv.messages.forEach(m => {
                const wrapper = document.createElement("div");
                wrapper.className = "message " + m.sender;
                const p = document.createElement("p");
                p.textContent = m.text;
                wrapper.appendChild(p);
                if (m.sender !== "user") {
                    const loa = document.createElement("i");
                    loa.className = "fas fa-volume-up icon_loa";
                    loa.addEventListener("click", () => {
                        fetch('/tts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: m.text })
                        })
                        .then(res => res.blob())
                        .then(blob => new Audio(URL.createObjectURL(blob)).play());
                    });
                    wrapper.appendChild(loa);
                }
                conversation.appendChild(wrapper);
            });
            conversation.scrollTop = conversation.scrollHeight;
        }

        document.querySelector(".menu_title").addEventListener("click", () => {
            if (currentConversation.messages.length > 0) {
                currentConversation.title = "Lịch sử " + (conversations.length + 1);
                conversations.push({ ...currentConversation });
                saveConversations();
                renderHistory();
            }
            currentConversation = { id: Date.now(), title: "Cuộc trò chuyện mới", messages: [] };
            conversation.innerHTML = "";
        });

        document.querySelector(".hamburger").addEventListener("click", () => {
            document.querySelector(".menu").classList.toggle("collapsed");
        });

        renderHistory();
    </script>
</body>
</html>
